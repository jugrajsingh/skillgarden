# GitMastery Hooks System

## Architecture

```text
guard.sh (PreToolUse dispatcher)
├── handlers/git_add.sh     # Validates git add commands
└── handlers/git_commit.sh  # Validates git commit commands
```

## Handler Contract

- **Input:** Command string as `$1` argument
- **Output:** Error messages to stderr
- **Exit codes:** 0=allow, 2=block, 1=error

Handlers receive the cleaned sub-command (env vars stripped, compound commands split).

## guard.sh Flow

1. Read JSON from stdin, extract `.tool_input.command` via `jq`
2. Fast path: if no pattern matches the full command, exit 0 immediately (~9ms)
3. Split compound commands (`&&`, `||`, `|`, `;`) into sub-commands using RS (0x1e) delimiter to preserve newlines in multiline commit messages
4. Strip leading env var assignments (`VAR=val cmd` → `cmd`)
5. Match each sub-command against patterns, dispatch to handler
6. Block on first handler failure

## Compound Command Splitting

Uses ASCII Record Separator (0x1e) instead of newlines as the internal delimiter. This preserves newlines embedded in quoted strings (multiline commit messages) while still splitting on shell operators.

The previous approach used newlines, which broke multiline commit messages into separate "sub-commands".

## git_add.sh Rules

| Check | Example | Message |
|-------|---------|---------|
| Bulk flags | `-A`, `--all`, `-u`, `--update` | stages too broadly |
| Globs | `*.py`, `src/?` | contains a glob |
| Directories | `src`, `.`, `tests/` | is a directory |

Uses `eval set --` for quote-aware tokenization.

## git_commit.sh Rules

| Check | Order | Message |
|-------|-------|---------|
| AI footers | 1st | Co-Authored-By: Claude, @anthropic.com, Generated by |
| Conventional format | 2nd | type(scope): subject |

Message extraction priority:

1. Heredoc: `-m "$(cat <<'EOF' ... EOF)"`
2. Double-quoted: `-m "..."`
3. Single-quoted: `-m '...'`
4. No `-m` flag → allow (editor mode)

Uses pure bash parameter expansion for message extraction (handles multiline).

## Testing

```bash
# All tests run from repo root
echo '{"tool_input":{"command":"git add CHANGELOG.md"}}' | bash plugins/gitmastery/hooks/guard.sh
echo '{"tool_input":{"command":"git add -A"}}' | bash plugins/gitmastery/hooks/guard.sh
echo '{"tool_input":{"command":"git commit -m \"feat: add feature\""}}' | bash plugins/gitmastery/hooks/guard.sh

# Direct handler testing
plugins/gitmastery/hooks/handlers/git_add.sh "git add -A"
plugins/gitmastery/hooks/handlers/git_commit.sh 'git commit -m "feat: thing"'
```

## Performance

| Path | Time |
|------|------|
| Unrelated command (fast) | ~9ms |
| Handler dispatch | ~13ms |

No Python interpreter startup — pure bash throughout.

## Gotchas

- `set -euo pipefail` in guard.sh but only `set -uo pipefail` in git_commit.sh (grep exit code 1 on no-match conflicts with `set -e`)
- `eval set --` in git_add.sh for tokenization — handles quoted paths but has shell expansion risks on malicious input (acceptable: input comes from Claude Code, not users)
- `read -r -d '' -a segments` needs `|| true` because read returns non-zero at EOF without finding the delimiter
